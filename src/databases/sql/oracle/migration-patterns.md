# Oracle — Migration Patterns

## CRITICAL: DDL Is Auto-Commit in Oracle

Oracle performs an **implicit COMMIT** before and after every DDL statement. `BEGIN; ... COMMIT;` wrapping has NO effect on DDL. A migration with multiple DDL statements cannot be rolled back atomically.

```sql
-- This does NOT provide transactional safety for DDL:
BEGIN;
CREATE TABLE foo (...);  -- IMPLICIT COMMIT happens here
CREATE TABLE bar (...);  -- If this fails, foo already exists
COMMIT;
```

**Mitigation:** Keep one DDL operation per migration file when atomicity matters.

## Migration Tool Comparison

| Feature | Flyway | Liquibase |
|---------|--------|-----------|
| Oracle support | Via `flyway-database-oracle` add-on | Built-in, mature |
| DDL transactions | No (Oracle limitation) | No (Oracle limitation) |
| Rollback | Manual (write undo scripts) | Auto-generated for many operations |
| Preconditions | No | Yes (`preConditions` checks before executing) |
| PL/SQL blocks | Supported (use `/` delimiter) | Supported via `splitStatements=false` |
| Recommendation | Simpler projects | Complex Oracle environments |

## IDENTITY Columns (12c+)

```sql
-- V1__create_transactions.sql
-- Generated Always: Oracle manages the value, cannot INSERT manually
CREATE TABLE app_schema.transactions (
    id NUMBER(19) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    stan VARCHAR2(6 CHAR) NOT NULL,
    mti VARCHAR2(4 CHAR) NOT NULL,
    amount_cents NUMBER(19) NOT NULL,
    response_code VARCHAR2(2 CHAR),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

-- Generated By Default: allows explicit INSERT (useful for data migration)
CREATE TABLE app_schema.merchants (
    id NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    mid VARCHAR2(15 CHAR) NOT NULL,
    name VARCHAR2(100 CHAR) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);
```

## SEQUENCE + TRIGGER (Pre-12c)

```sql
-- V1__create_transactions_pre12c.sql
CREATE SEQUENCE app_schema.seq_transactions START WITH 1 INCREMENT BY 1 NOCACHE;

CREATE TABLE app_schema.transactions (
    id NUMBER(19) NOT NULL PRIMARY KEY,
    stan VARCHAR2(6 CHAR) NOT NULL,
    mti VARCHAR2(4 CHAR) NOT NULL,
    amount_cents NUMBER(19) NOT NULL,
    response_code VARCHAR2(2 CHAR),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);
/

CREATE OR REPLACE TRIGGER app_schema.trg_transactions_id
    BEFORE INSERT ON app_schema.transactions
    FOR EACH ROW
    WHEN (NEW.id IS NULL)
BEGIN
    :NEW.id := app_schema.seq_transactions.NEXTVAL;
END;
/
```

## Flyway Template

```sql
-- V{N}__{description}.sql
-- Story: {TICKET}
-- Description: {what this migration does}
-- NOTE: DDL is auto-commit in Oracle. Each statement commits independently.

CREATE TABLE app_schema.table_name (
    id NUMBER(19) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    col1 VARCHAR2(100 CHAR) NOT NULL,
    col2 NUMBER(19),
    status VARCHAR2(20 CHAR) DEFAULT 'ACTIVE' NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE INDEX app_schema.idx_table_col1
    ON app_schema.table_name (col1);

CREATE UNIQUE INDEX app_schema.uq_table_col2
    ON app_schema.table_name (col2);

COMMENT ON TABLE app_schema.table_name IS 'Description of table purpose';
COMMENT ON COLUMN app_schema.table_name.col1 IS 'Description of column';
```

## Liquibase Template (XML)

```xml
<changeSet id="{N}-{description}" author="{author}">
    <preConditions onFail="MARK_RAN">
        <not><tableExists tableName="TABLE_NAME" schemaName="APP_SCHEMA"/></not>
    </preConditions>
    <createTable tableName="TABLE_NAME" schemaName="APP_SCHEMA">
        <column name="ID" type="NUMBER(19)" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="COL1" type="VARCHAR2(100 CHAR)">
            <constraints nullable="false"/>
        </column>
        <column name="CREATED_AT" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="SYSTIMESTAMP">
            <constraints nullable="false"/>
        </column>
    </createTable>
</changeSet>
```

## Best Practices

| Practice | Detail |
|----------|--------|
| One DDL per migration | Avoids partial-apply states (no transactional DDL) |
| Use `GENERATED ALWAYS AS IDENTITY` | 12c+; avoids sequence+trigger boilerplate |
| `SYSTIMESTAMP` over `SYSDATE` | `SYSTIMESTAMP` includes timezone |
| `VARCHAR2(N CHAR)` always | Prevents multi-byte truncation |
| Schema-qualify all objects | `app_schema.table_name` — never rely on session schema |
| Add `COMMENT ON` | Oracle metadata — aids DBA tooling |
| PL/SQL blocks end with `/` | Flyway requires `/` on its own line as delimiter |
| Test migrations on empty schema | Catch dependency ordering issues early |
| NEVER modify applied migrations | Create corrective migration instead |

## updated_at Trigger

Oracle has no `ON UPDATE CURRENT_TIMESTAMP`. Use a `BEFORE UPDATE` trigger setting `:NEW.updated_at := SYSTIMESTAMP;`.
